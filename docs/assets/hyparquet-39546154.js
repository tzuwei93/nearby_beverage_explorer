import{_ as De}from"./main-20c26f03.js";const X=["BOOLEAN","INT32","INT64","INT96","FLOAT","DOUBLE","BYTE_ARRAY","FIXED_LEN_BYTE_ARRAY"],R=["PLAIN","GROUP_VAR_INT","PLAIN_DICTIONARY","RLE","BIT_PACKED","DELTA_BINARY_PACKED","DELTA_LENGTH_BYTE_ARRAY","DELTA_BYTE_ARRAY","RLE_DICTIONARY","BYTE_STREAM_SPLIT"],Oe=["REQUIRED","OPTIONAL","REPEATED"],Te=["UTF8","MAP","MAP_KEY_VALUE","LIST","ENUM","DECIMAL","DATE","TIME_MILLIS","TIME_MICROS","TIMESTAMP_MILLIS","TIMESTAMP_MICROS","UINT_8","UINT_16","UINT_32","UINT_64","INT_8","INT_16","INT_32","INT_64","JSON","BSON","INTERVAL"],Pe=["UNCOMPRESSED","SNAPPY","GZIP","LZO","BROTLI","LZ4","ZSTD","LZ4_RAW"],ue=["DATA_PAGE","INDEX_PAGE","DICTIONARY_PAGE","DATA_PAGE_V2"],le=864e5;function J(e,t,n,f,r){if(t&&f.endsWith("_DICTIONARY")){let i=e;e instanceof Uint8Array&&!(t instanceof Uint8Array)&&(i=new t.constructor(e.length));for(let s=0;s<e.length;s++)i[s]=t[e[s]];return i}else return ce(e,n,r)}function ce(e,t,n=!0){const{type:f,converted_type:r,logical_type:i}=t;if(r==="DECIMAL"){const o=10**-(t.scale||0),u=new Array(e.length);for(let a=0;a<u.length;a++)e[0]instanceof Uint8Array?u[a]=ae(e[a])*o:u[a]=Number(e[a])*o;return u}if(!r&&f==="INT96")return Array.from(e).map(Be);if(r==="DATE"){const s=new Array(e.length);for(let o=0;o<s.length;o++)s[o]=new Date(e[o]*le);return s}if(r==="TIMESTAMP_MILLIS"){const s=new Array(e.length);for(let o=0;o<s.length;o++)s[o]=new Date(Number(e[o]));return s}if(r==="TIMESTAMP_MICROS"){const s=new Array(e.length);for(let o=0;o<s.length;o++)s[o]=new Date(Number(e[o]/1000n));return s}if(r==="JSON"){const s=new TextDecoder;return e.map(o=>JSON.parse(s.decode(o)))}if(r==="BSON")throw new Error("parquet bson not supported");if(r==="INTERVAL")throw new Error("parquet interval not supported");if(r==="UTF8"||(i==null?void 0:i.type)==="STRING"||n&&f==="BYTE_ARRAY"){const s=new TextDecoder,o=new Array(e.length);for(let u=0;u<o.length;u++)o[u]=e[u]&&s.decode(e[u]);return o}if(r==="UINT_64"||(i==null?void 0:i.type)==="INTEGER"&&i.bitWidth===64&&!i.isSigned){if(e instanceof BigInt64Array)return new BigUint64Array(e.buffer,e.byteOffset,e.length);const s=new BigUint64Array(e.length);for(let o=0;o<s.length;o++)s[o]=BigInt(e[o]);return s}if(r==="UINT_32"||(i==null?void 0:i.type)==="INTEGER"&&i.bitWidth===32&&!i.isSigned){if(e instanceof Int32Array)return new Uint32Array(e.buffer,e.byteOffset,e.length);const s=new Uint32Array(e.length);for(let o=0;o<s.length;o++)s[o]=e[o];return s}if((i==null?void 0:i.type)==="FLOAT16")return Array.from(e).map(_e);if((i==null?void 0:i.type)==="TIMESTAMP"){const{unit:s}=i;let o=1n;s==="MICROS"&&(o=1000n),s==="NANOS"&&(o=1000000n);const u=new Array(e.length);for(let a=0;a<u.length;a++)u[a]=new Date(Number(e[a]/o));return u}return e}function ae(e){let t=0;for(const f of e)t=t*256+f;const n=e.length*8;return t>=2**(n-1)&&(t-=2**n),t}function Be(e){const t=Number((e>>64n)-2440588n),n=Number((e&0xffffffffffffffffn)/1000000n),f=t*le+n;return new Date(f)}function _e(e){if(!e)return;const t=e[1]<<8|e[0],n=t>>15?-1:1,f=t>>10&31,r=t&1023;return f===0?n*2**-14*(r/1024):f===31?r?NaN:n*(1/0):n*2**(f-15)*(1+r/1024)}function de(e,t,n){const f=e[t],r=[];let i=1;if(f.num_children)for(;r.length<f.num_children;){const s=e[t+i],o=de(e,t+i,[...n,s.name]);i+=o.count,r.push(o)}return{count:i,element:f,children:r,path:n}}function V(e,t){let n=de(e,0,[]);const f=[n];for(const r of t){const i=n.children.find(s=>s.element.name===r);if(!i)throw new Error(`parquet schema element not found: ${t}`);f.push(i),n=i}return f}function we(e){let t=0;for(const{element:n}of e)n.repetition_type==="REPEATED"&&t++;return t}function j(e){let t=0;for(const{element:n}of e.slice(1))n.repetition_type!=="REQUIRED"&&t++;return t}function Se(e){if(!e||e.element.converted_type!=="LIST"||e.children.length>1)return!1;const t=e.children[0];return!(t.children.length>1||t.element.repetition_type!=="REPEATED")}function Ue(e){if(!e||e.element.converted_type!=="MAP"||e.children.length>1)return!1;const t=e.children[0];if(t.children.length!==2||t.element.repetition_type!=="REPEATED")return!1;const n=t.children.find(r=>r.element.name==="key");if((n==null?void 0:n.element.repetition_type)==="REPEATED")return!1;const f=t.children.find(r=>r.element.name==="value");return(f==null?void 0:f.element.repetition_type)!=="REPEATED"}function Me(e){if(e.length!==2)return!1;const[,t]=e;return!(t.element.repetition_type==="REPEATED"||t.children.length)}const p={STOP:0,TRUE:1,FALSE:2,BYTE:3,I16:4,I32:5,I64:6,DOUBLE:7,BINARY:8,LIST:9,SET:10,MAP:11,STRUCT:12,UUID:13};function he(e){let t=0;const n={};for(;e.offset<e.view.byteLength;){const[f,r,i]=Ee(e,t);if(t=i,f===p.STOP)break;n[`field_${r}`]=Y(e,f)}return n}function Y(e,t){switch(t){case p.TRUE:return!0;case p.FALSE:return!1;case p.BYTE:return e.view.getInt8(e.offset++);case p.I16:case p.I32:return $e(e);case p.I64:return z(e);case p.DOUBLE:{const n=e.view.getFloat64(e.offset,!0);return e.offset+=8,n}case p.BINARY:{const n=D(e),f=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,n);return e.offset+=n,f}case p.LIST:{const[n,f]=qe(e),r=n===p.TRUE||n===p.FALSE,i=new Array(f);for(let s=0;s<f;s++)i[s]=r?Y(e,p.BYTE)===1:Y(e,n);return i}case p.STRUCT:{const n={};let f=0;for(;;){let r,i;if([r,i,f]=Ee(e,f),r===p.STOP)break;n[`field_${i}`]=Y(e,r)}return n}default:throw new Error(`thrift unhandled type: ${t}`)}}function D(e){let t=0,n=0;for(;;){const f=e.view.getUint8(e.offset++);if(t|=(f&127)<<n,!(f&128))return t;n+=7}}function xe(e){let t=0n,n=0n;for(;;){const f=e.view.getUint8(e.offset++);if(t|=BigInt(f&127)<<n,!(f&128))return t;n+=7n}}function $e(e){const t=D(e);return t>>>1^-(t&1)}function z(e){const t=xe(e);return t>>1n^-(t&1n)}function Ae(e){return e&15}function Ee(e,t){const n=e.view.getUint8(e.offset++);if((n&15)===p.STOP)return[0,0,t];const f=n>>4;let r;if(f)r=t+f;else throw new Error("non-delta field id not supported");return[Ae(n),r,r]}function qe(e){const t=e.view.getUint8(e.offset++),n=t>>4,f=Ae(t);if(n===15){const r=D(e);return[f,r]}return[f,n]}const ge=1<<19;async function Q(e,t=ge){if(!e||!(e.byteLength>=0))throw new Error("parquetMetadataAsync expected AsyncBuffer");const n=Math.max(0,e.byteLength-t),f=await e.slice(n,e.byteLength),r=new DataView(f);if(r.getUint32(f.byteLength-4,!0)!==827474256)throw new Error("parquet file invalid (footer != PAR1)");const i=r.getUint32(f.byteLength-8,!0);if(i>e.byteLength-8)throw new Error(`parquet metadata length ${i} exceeds available buffer ${e.byteLength-8}`);if(i+8>t){const s=e.byteLength-i-8,o=await e.slice(s,n),u=new ArrayBuffer(i+8),a=new Uint8Array(u);return a.set(new Uint8Array(o)),a.set(new Uint8Array(f),n-s),ee(u)}else return ee(f)}function ee(e){var m;if(!(e instanceof ArrayBuffer))throw new Error("parquetMetadata expected ArrayBuffer");const t=new DataView(e);if(t.byteLength<8)throw new Error("parquet file is too short");if(t.getUint32(t.byteLength-4,!0)!==827474256)throw new Error("parquet file invalid (footer != PAR1)");const n=t.byteLength-8,f=t.getUint32(n,!0);if(f>t.byteLength-8)throw new Error(`parquet metadata length ${f} exceeds available buffer ${t.byteLength-8}`);const r=n-f,s=he({view:t,offset:r}),o=new TextDecoder;function u(_){return _&&o.decode(_)}const a=s.field_1,c=s.field_2.map(_=>({type:X[_.field_1],type_length:_.field_2,repetition_type:Oe[_.field_3],name:u(_.field_4),num_children:_.field_5,converted_type:Te[_.field_6],scale:_.field_7,precision:_.field_8,field_id:_.field_9,logical_type:Ye(_.field_10)})),l=c.filter(_=>_.type),h=s.field_3,d=s.field_4.map(_=>{var E;return{columns:_.field_1.map((w,v)=>{var y,I;return{file_path:u(w.field_1),file_offset:w.field_2,meta_data:w.field_3&&{type:X[w.field_3.field_1],encodings:(y=w.field_3.field_2)==null?void 0:y.map(b=>R[b]),path_in_schema:w.field_3.field_3.map(u),codec:Pe[w.field_3.field_4],num_values:w.field_3.field_5,total_uncompressed_size:w.field_3.field_6,total_compressed_size:w.field_3.field_7,key_value_metadata:w.field_3.field_8,data_page_offset:w.field_3.field_9,index_page_offset:w.field_3.field_10,dictionary_page_offset:w.field_3.field_11,statistics:Ce(w.field_3.field_12,l[v]),encoding_stats:(I=w.field_3.field_13)==null?void 0:I.map(b=>({page_type:ue[b.field_1],encoding:R[b.field_2],count:b.field_3})),bloom_filter_offset:w.field_3.field_14,bloom_filter_length:w.field_3.field_15,size_statistics:w.field_3.field_16&&{unencoded_byte_array_data_bytes:w.field_3.field_16.field_1,repetition_level_histogram:w.field_3.field_16.field_2,definition_level_histogram:w.field_3.field_16.field_3}},offset_index_offset:w.field_4,offset_index_length:w.field_5,column_index_offset:w.field_6,column_index_length:w.field_7,crypto_metadata:w.field_8,encrypted_column_metadata:w.field_9}}),total_byte_size:_.field_2,num_rows:_.field_3,sorting_columns:(E=_.field_4)==null?void 0:E.map(w=>({column_idx:w.field_1,descending:w.field_2,nulls_first:w.field_3})),file_offset:_.field_5,total_compressed_size:_.field_6,ordinal:_.field_7}}),A=(m=s.field_5)==null?void 0:m.map(_=>({key:u(_.field_1),value:u(_.field_2)})),g=u(s.field_6);return{version:a,schema:c,num_rows:h,row_groups:d,key_value_metadata:A,created_by:g,metadata_length:f}}function mt({schema:e}){return V(e,[])[0]}function Ye(e){return e!=null&&e.field_1?{type:"STRING"}:e!=null&&e.field_2?{type:"MAP"}:e!=null&&e.field_3?{type:"LIST"}:e!=null&&e.field_4?{type:"ENUM"}:e!=null&&e.field_5?{type:"DECIMAL",scale:e.field_5.field_1,precision:e.field_5.field_2}:e!=null&&e.field_6?{type:"DATE"}:e!=null&&e.field_7?{type:"TIME",isAdjustedToUTC:e.field_7.field_1,unit:te(e.field_7.field_2)}:e!=null&&e.field_8?{type:"TIMESTAMP",isAdjustedToUTC:e.field_8.field_1,unit:te(e.field_8.field_2)}:e!=null&&e.field_10?{type:"INTEGER",bitWidth:e.field_10.field_1,isSigned:e.field_10.field_2}:e!=null&&e.field_11?{type:"NULL"}:e!=null&&e.field_12?{type:"JSON"}:e!=null&&e.field_13?{type:"BSON"}:e!=null&&e.field_14?{type:"UUID"}:e!=null&&e.field_15?{type:"FLOAT16"}:e}function te(e){if(e.field_1)return"MILLIS";if(e.field_2)return"MICROS";if(e.field_3)return"NANOS";throw new Error("parquet time unit required")}function Ce(e,t){return e&&{max:q(e.field_1,t),min:q(e.field_2,t),null_count:e.field_3,distinct_count:e.field_4,max_value:q(e.field_5,t),min_value:q(e.field_6,t),is_max_value_exact:e.field_7,is_min_value_exact:e.field_8}}function q(e,t){const{type:n,converted_type:f,logical_type:r}=t;if(e===void 0)return e;if(n==="BOOLEAN")return e[0]===1;if(n==="BYTE_ARRAY")return new TextDecoder().decode(e);const i=new DataView(e.buffer,e.byteOffset,e.byteLength);return n==="FLOAT"&&i.byteLength===4?i.getFloat32(0,!0):n==="DOUBLE"&&i.byteLength===8?i.getFloat64(0,!0):n==="INT32"&&f==="DATE"?new Date(i.getInt32(0,!0)*864e5):n==="INT64"&&f==="TIMESTAMP_MICROS"?new Date(Number(i.getBigInt64(0,!0)/1000n)):n==="INT64"&&f==="TIMESTAMP_MILLIS"?new Date(Number(i.getBigInt64(0,!0))):n==="INT64"&&(r==null?void 0:r.type)==="TIMESTAMP"&&(r==null?void 0:r.unit)==="NANOS"?new Date(Number(i.getBigInt64(0,!0)/1000000n)):n==="INT64"&&(r==null?void 0:r.type)==="TIMESTAMP"&&(r==null?void 0:r.unit)==="MICROS"?new Date(Number(i.getBigInt64(0,!0)/1000n)):n==="INT64"&&(r==null?void 0:r.type)==="TIMESTAMP"?new Date(Number(i.getBigInt64(0,!0))):n==="INT32"&&i.byteLength===4?i.getInt32(0,!0):n==="INT64"&&i.byteLength===8?i.getBigInt64(0,!0):f==="DECIMAL"?ae(e)*10**-(t.scale||0):(r==null?void 0:r.type)==="FLOAT16"?_e(e):e}function ne(e,t,n,f,r){const i=(t==null?void 0:t.length)||n.length;if(!i)return f;const s=j(r),o=r.map(({element:A})=>A.repetition_type);let u=0;const a=[e];let c=e,l=0,h=0,d=0;if(n[0])for(;l<o.length-2&&d<n[0];){if(!c)throw new Error("parquet cannot resume previous page");c=c.at(-1),a.push(c),l++,o[l]!=="REQUIRED"&&h++,o[l]==="REPEATED"&&d++}for(let A=0;A<i;A++){const g=t!=null&&t.length?t[A]:s,m=n[A];for(;l&&(m<d||o[l]!=="REPEATED");)o[l]!=="REQUIRED"&&(a.pop(),h--),o[l]==="REPEATED"&&d--,l--;for(c=a.at(-1);(l<o.length-2||o[l+1]==="REPEATED")&&(h<g||o[l+1]==="REQUIRED");){if(l++,o[l]!=="REQUIRED"){const _=[];c.push(_),c=_,a.push(_),h++}o[l]==="REPEATED"&&d++}g===s?c.push(f[u++]):l===o.length-2?c.push(null):c.push([])}if(!e.length)for(let A=0;A<s;A++){const g=[];c.push(g),c=g}return e}function B(e,t,n=0){const f=t.path.join("."),r=t.element.repetition_type==="OPTIONAL",i=r?n+1:n;if(Se(t)){let s=t.children[0],o=i;s.children.length===1&&(s=s.children[0],o++),B(e,s,o);const u=s.path.join("."),a=e.get(u);if(!a)throw new Error("parquet list column missing values");r&&C(a,n),e.set(f,a),e.delete(u);return}if(Ue(t)){const s=t.children[0].element.name;B(e,t.children[0].children[0],i+1),B(e,t.children[0].children[1],i+1);const o=e.get(`${f}.${s}.key`),u=e.get(`${f}.${s}.value`);if(!o)throw new Error("parquet map column missing keys");if(!u)throw new Error("parquet map column missing values");if(o.length!==u.length)throw new Error("parquet map column key/value length mismatch");const a=me(o,u,i);r&&C(a,n),e.delete(`${f}.${s}.key`),e.delete(`${f}.${s}.value`),e.set(f,a);return}if(t.children.length){const s=t.element.repetition_type==="REQUIRED"?n:n+1,o={};for(const a of t.children){B(e,a,s);const c=e.get(a.path.join("."));if(!c)throw new Error("parquet struct missing child data");o[a.element.name]=c}for(const a of t.children)e.delete(a.path.join("."));const u=ye(o,s);r&&C(u,n),e.set(f,u)}}function C(e,t){for(let n=0;n<e.length;n++)t?C(e[n],t-1):e[n]=e[n][0]}function me(e,t,n){const f=[];for(let r=0;r<e.length;r++)if(n)f.push(me(e[r],t[r],n-1));else if(e[r]){const i={};for(let s=0;s<e[r].length;s++){const o=t[r][s];i[e[r][s]]=o===void 0?null:o}f.push(i)}else f.push(void 0);return f}function ye(e,t){var i;const n=Object.keys(e),f=(i=e[n[0]])==null?void 0:i.length,r=[];for(let s=0;s<f;s++){const o={};for(const u of n){if(e[u].length!==f)throw new Error("parquet struct parsing error");o[u]=e[u][s]}t?r.push(ye(o,t-1)):r.push(o)}return r}function M(e,t,n){const f=n instanceof Int32Array,r=D(e),i=D(e);D(e);let s=z(e),o=0;n[o++]=f?Number(s):s;const u=r/i;for(;o<t;){const a=z(e),c=new Uint8Array(i);for(let l=0;l<i;l++)c[l]=e.view.getUint8(e.offset++);for(let l=0;l<i&&o<t;l++){const h=BigInt(c[l]);if(h){let d=0n,A=u;const g=(1n<<h)-1n;for(;A&&o<t;){let m=BigInt(e.view.getUint8(e.offset))>>d&g;for(d+=h;d>=8;)d-=8n,e.offset++,d&&(m|=BigInt(e.view.getUint8(e.offset))<<h-d&g);const _=a+m;s+=_,n[o++]=f?Number(s):s,A--}A&&(e.offset+=Math.ceil((A*Number(h)+Number(d))/8))}else for(let d=0;d<u&&o<t;d++)s+=a,n[o++]=f?Number(s):s}}}function pe(e,t,n){const f=new Int32Array(t);M(e,t,f);for(let r=0;r<t;r++)n[r]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,f[r]),e.offset+=f[r]}function Fe(e,t,n){const f=new Int32Array(t);M(e,t,f);const r=new Int32Array(t);M(e,t,r);for(let i=0;i<t;i++){const s=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,r[i]);f[i]?(n[i]=new Uint8Array(f[i]+r[i]),n[i].set(n[i-1].subarray(0,f[i])),n[i].set(s,f[i])):n[i]=s,e.offset+=r[i]}}function F(e){return 32-Math.clz32(e)}function L(e,t,n,f){n||(e.offset+=4);let r=0;for(;r<f.length;){const i=D(e);if(i&1)r=Ve(e,i,t,f,r);else{const s=i>>>1;ke(e,s,t,f,r),r+=s}}}function ke(e,t,n,f,r){const i=n+7>>3;let s=0;for(let o=0;o<i;o++)s|=e.view.getUint8(e.offset++)<<(o<<3);for(let o=0;o<t;o++)f[r+o]=s}function Ve(e,t,n,f,r){let i=t>>1<<3;const s=(1<<n)-1;let o=0;if(e.offset<e.view.byteLength)o=e.view.getUint8(e.offset++);else if(s)throw new Error(`parquet bitpack offset ${e.offset} out of range`);let u=8,a=0;for(;i;)a>8?(a-=8,u-=8,o>>>=8):u-a<n?(o|=e.view.getUint8(e.offset)<<u,e.offset++,u+=8):(r<f.length&&(f[r++]=o>>a&s),i--,a+=n);return r}function Ie(e,t,n,f){const r=ze(n,f),i=new Uint8Array(t*r);for(let s=0;s<r;s++)for(let o=0;o<t;o++)i[o*r+s]=e.view.getUint8(e.offset++);if(n==="FLOAT")return new Float32Array(i.buffer);if(n==="DOUBLE")return new Float64Array(i.buffer);if(n==="INT32")return new Int32Array(i.buffer);if(n==="INT64")return new BigInt64Array(i.buffer);if(n==="FIXED_LEN_BYTE_ARRAY"){const s=new Array(t);for(let o=0;o<t;o++)s[o]=i.subarray(o*r,(o+1)*r);return s}throw new Error(`parquet byte_stream_split unsupported type: ${n}`)}function ze(e,t){switch(e){case"INT32":case"FLOAT":return 4;case"INT64":case"DOUBLE":return 8;case"FIXED_LEN_BYTE_ARRAY":if(!t)throw new Error("parquet byteWidth missing type_length");return t;default:throw new Error(`parquet unsupported type: ${e}`)}}function W(e,t,n,f){if(n===0)return[];if(t==="BOOLEAN")return Ge(e,n);if(t==="INT32")return je(e,n);if(t==="INT64")return Qe(e,n);if(t==="INT96")return We(e,n);if(t==="FLOAT")return Ze(e,n);if(t==="DOUBLE")return He(e,n);if(t==="BYTE_ARRAY")return Ke(e,n);if(t==="FIXED_LEN_BYTE_ARRAY"){if(!f)throw new Error("parquet missing fixed length");return Xe(e,n,f)}else throw new Error(`parquet unhandled type: ${t}`)}function Ge(e,t){const n=new Array(t);for(let f=0;f<t;f++){const r=e.offset+(f/8|0),i=f%8,s=e.view.getUint8(r);n[f]=(s&1<<i)!==0}return e.offset+=Math.ceil(t/8),n}function je(e,t){const n=(e.view.byteOffset+e.offset)%4?new Int32Array(k(e.view.buffer,e.view.byteOffset+e.offset,t*4)):new Int32Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*4,n}function Qe(e,t){const n=(e.view.byteOffset+e.offset)%8?new BigInt64Array(k(e.view.buffer,e.view.byteOffset+e.offset,t*8)):new BigInt64Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*8,n}function We(e,t){const n=new Array(t);for(let f=0;f<t;f++){const r=e.view.getBigInt64(e.offset+f*12,!0),i=e.view.getInt32(e.offset+f*12+8,!0);n[f]=BigInt(i)<<64n|r}return e.offset+=t*12,n}function Ze(e,t){const n=(e.view.byteOffset+e.offset)%4?new Float32Array(k(e.view.buffer,e.view.byteOffset+e.offset,t*4)):new Float32Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*4,n}function He(e,t){const n=(e.view.byteOffset+e.offset)%8?new Float64Array(k(e.view.buffer,e.view.byteOffset+e.offset,t*8)):new Float64Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*8,n}function Ke(e,t){const n=new Array(t);for(let f=0;f<t;f++){const r=e.view.getUint32(e.offset,!0);e.offset+=4,n[f]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,r),e.offset+=r}return n}function Xe(e,t,n){const f=new Array(t);for(let r=0;r<t;r++)f[r]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,n),e.offset+=n;return f}function k(e,t,n){const f=new ArrayBuffer(n);return new Uint8Array(f).set(new Uint8Array(e,t,n)),f}const Je=[0,255,65535,16777215,4294967295];function re(e,t,n,f,r){for(let i=0;i<r;i++)n[f+i]=e[t+i]}function et(e,t){const n=e.byteLength,f=t.byteLength;let r=0,i=0;for(;r<n;){const s=e[r];if(r++,s<128)break}if(f&&r>=n)throw new Error("invalid snappy length header");for(;r<n;){const s=e[r];let o=0;if(r++,r>=n)throw new Error("missing eof marker");if(s&3){let u=0;switch(s&3){case 1:o=(s>>>2&7)+4,u=e[r]+(s>>>5<<8),r++;break;case 2:if(n<=r+1)throw new Error("snappy error end of input");o=(s>>>2)+1,u=e[r]+(e[r+1]<<8),r+=2;break;case 3:if(n<=r+3)throw new Error("snappy error end of input");o=(s>>>2)+1,u=e[r]+(e[r+1]<<8)+(e[r+2]<<16)+(e[r+3]<<24),r+=4;break}if(u===0||isNaN(u))throw new Error(`invalid offset ${u} pos ${r} inputLength ${n}`);if(u>i)throw new Error("cannot copy from before start of buffer");re(t,i-u,t,i,o),i+=o}else{let u=(s>>>2)+1;if(u>60){if(r+3>=n)throw new Error("snappy error literal pos + 3 >= inputLength");const a=u-60;u=e[r]+(e[r+1]<<8)+(e[r+2]<<16)+(e[r+3]<<24),u=(u&Je[a])+1,r+=a}if(r+u>n)throw new Error("snappy error literal exceeds input length");re(e,r,t,i,u),r+=u,i+=u}}if(i!==f)throw new Error("premature end of input")}function tt(e,t,{type:n,element:f,schemaPath:r}){const i=new DataView(e.buffer,e.byteOffset,e.byteLength),s={view:i,offset:0};let o;const u=nt(s,t,r),{definitionLevels:a,numNulls:c}=rt(s,t,r),l=t.num_values-c;if(t.encoding==="PLAIN")o=W(s,n,l,f.type_length);else if(t.encoding==="PLAIN_DICTIONARY"||t.encoding==="RLE_DICTIONARY"||t.encoding==="RLE"){const h=n==="BOOLEAN"?1:i.getUint8(s.offset++);h?(o=new Array(l),n==="BOOLEAN"?(L(s,h,0,o),o=o.map(d=>!!d)):L(s,h,i.byteLength-s.offset,o)):o=new Uint8Array(l)}else if(t.encoding==="BYTE_STREAM_SPLIT")o=Ie(s,l,n,f.type_length);else if(t.encoding==="DELTA_BINARY_PACKED")o=n==="INT32"?new Int32Array(l):new BigInt64Array(l),M(s,l,o);else if(t.encoding==="DELTA_LENGTH_BYTE_ARRAY")o=new Array(l),pe(s,l,o);else throw new Error(`parquet unsupported encoding: ${t.encoding}`);return{definitionLevels:a,repetitionLevels:u,dataPage:o}}function nt(e,t,n){if(n.length>1){const f=we(n);if(f){const r=new Array(t.num_values);return L(e,F(f),0,r),r}}return[]}function rt(e,t,n){const f=j(n);if(!f)return{definitionLevels:[],numNulls:0};const r=new Array(t.num_values);L(e,F(f),0,r);let i=t.num_values;for(const s of r)s===f&&i--;return i===0&&(r.length=0),{definitionLevels:r,numNulls:i}}function G(e,t,n,f){let r;const i=f==null?void 0:f[n];if(n==="UNCOMPRESSED")r=e;else if(i)r=i(e,t);else if(n==="SNAPPY")r=new Uint8Array(t),et(e,r);else throw new Error(`parquet unsupported compression codec: ${n}`);if((r==null?void 0:r.length)!==t)throw new Error(`parquet decompressed page length ${r==null?void 0:r.length} does not match header ${t}`);return r}function ft(e,t,n){const r={view:new DataView(e.buffer,e.byteOffset,e.byteLength),offset:0},{type:i,element:s,schemaPath:o,codec:u,compressors:a}=n,c=t.data_page_header_v2;if(!c)throw new Error("parquet data page header v2 is undefined");const l=it(r,c,o);r.offset=c.repetition_levels_byte_length;const h=st(r,c,o),d=t.uncompressed_page_size-c.definition_levels_byte_length-c.repetition_levels_byte_length;let A=e.subarray(r.offset);c.is_compressed!==!1&&(A=G(A,d,u,a));const g=new DataView(A.buffer,A.byteOffset,A.byteLength),m={view:g,offset:0};let _;const E=c.num_values-c.num_nulls;if(c.encoding==="PLAIN")_=W(m,i,E,s.type_length);else if(c.encoding==="RLE")_=new Array(E),L(m,1,0,_),_=_.map(w=>!!w);else if(c.encoding==="PLAIN_DICTIONARY"||c.encoding==="RLE_DICTIONARY"){const w=g.getUint8(m.offset++);_=new Array(E),L(m,w,d-1,_)}else if(c.encoding==="DELTA_BINARY_PACKED")_=i==="INT32"?new Int32Array(E):new BigInt64Array(E),M(m,E,_);else if(c.encoding==="DELTA_LENGTH_BYTE_ARRAY")_=new Array(E),pe(m,E,_);else if(c.encoding==="DELTA_BYTE_ARRAY")_=new Array(E),Fe(m,E,_);else if(c.encoding==="BYTE_STREAM_SPLIT")_=Ie(r,E,i,s.type_length);else throw new Error(`parquet unsupported encoding: ${c.encoding}`);return{definitionLevels:h,repetitionLevels:l,dataPage:_}}function it(e,t,n){const f=we(n);if(!f)return[];const r=new Array(t.num_values);return L(e,F(f),t.repetition_levels_byte_length,r),r}function st(e,t,n){const f=j(n);if(f){const r=new Array(t.num_values);return L(e,F(f),t.definition_levels_byte_length,r),r}}function ot(e,{groupStart:t,selectStart:n,selectEnd:f},r,i){const{columnName:s,element:o,utf8:u}=r,a=[];let c,l,h=0;const d=i&&(()=>{l&&i({columnName:s,columnData:l,rowStart:t+h-l.length,rowEnd:t+h})});for(;h<f&&!(e.offset>=e.view.byteLength-1);){const A=ut(e);if(A.type==="DICTIONARY_PAGE")c=fe(e,A,r,c,void 0,0),c=ce(c,o,u);else{const g=(l==null?void 0:l.length)||0,m=fe(e,A,r,c,l,n-h);l===m?h+=m.length-g:(d==null||d(),a.push(m),h+=m.length,l=m)}}return d==null||d(),h>f&&l&&(a[a.length-1]=l.slice(0,f-(h-l.length))),a}function fe(e,t,n,f,r,i){const{type:s,element:o,schemaPath:u,codec:a,compressors:c,utf8:l}=n,h=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,t.compressed_page_size);if(e.offset+=t.compressed_page_size,t.type==="DATA_PAGE"){const d=t.data_page_header;if(!d)throw new Error("parquet data page header is undefined");if(i>d.num_values&&Me(u))return new Array(d.num_values);const A=G(h,Number(t.uncompressed_page_size),a,c),{definitionLevels:g,repetitionLevels:m,dataPage:_}=tt(A,d,n);let E=J(_,f,o,d.encoding,l);if(m.length||g!=null&&g.length){const w=Array.isArray(r)?r:[];return ne(w,g,m,E,u)}else{for(let w=2;w<u.length;w++)u[w].element.repetition_type!=="REQUIRED"&&(E=Array.from(E,v=>[v]));return E}}else if(t.type==="DATA_PAGE_V2"){const d=t.data_page_header_v2;if(!d)throw new Error("parquet data page header v2 is undefined");if(i>d.num_rows)return new Array(d.num_values);const{definitionLevels:A,repetitionLevels:g,dataPage:m}=ft(h,t,n),_=J(m,f,o,d.encoding,l),E=Array.isArray(r)?r:[];return ne(E,A,g,_,u)}else if(t.type==="DICTIONARY_PAGE"){const d=t.dictionary_page_header;if(!d)throw new Error("parquet dictionary page header is undefined");const A=G(h,Number(t.uncompressed_page_size),a,c),g={view:new DataView(A.buffer,A.byteOffset,A.byteLength),offset:0};return W(g,s,d.num_values,o.type_length)}else throw new Error(`parquet unsupported page type: ${t.type}`)}function ut(e){const t=he(e),n=ue[t.field_1],f=t.field_2,r=t.field_3,i=t.field_4,s=t.field_5&&{num_values:t.field_5.field_1,encoding:R[t.field_5.field_2],definition_level_encoding:R[t.field_5.field_3],repetition_level_encoding:R[t.field_5.field_4],statistics:t.field_5.field_5&&{max:t.field_5.field_5.field_1,min:t.field_5.field_5.field_2,null_count:t.field_5.field_5.field_3,distinct_count:t.field_5.field_5.field_4,max_value:t.field_5.field_5.field_5,min_value:t.field_5.field_5.field_6}},o=t.field_6,u=t.field_7&&{num_values:t.field_7.field_1,encoding:R[t.field_7.field_2],is_sorted:t.field_7.field_3},a=t.field_8&&{num_values:t.field_8.field_1,num_nulls:t.field_8.field_2,num_rows:t.field_8.field_3,encoding:R[t.field_8.field_4],definition_levels_byte_length:t.field_8.field_5,repetition_levels_byte_length:t.field_8.field_6,is_compressed:t.field_8.field_7===void 0?!0:t.field_8.field_7,statistics:t.field_8.field_8};return{type:n,uncompressed_page_size:f,compressed_page_size:r,crc:i,data_page_header:s,index_page_header:o,dictionary_page_header:u,data_page_header_v2:a}}function ie(e){if(e===void 0)return null;if(typeof e=="bigint")return Number(e);if(Array.isArray(e))return e.map(ie);if(e instanceof Uint8Array)return Array.from(e);if(e instanceof Date)return e.toISOString();if(e instanceof Object){const t={};for(const n of Object.keys(e))e[n]!==void 0&&(t[n]=ie(e[n]));return t}return e}function Z(e,t){for(let f=0;f<t.length;f+=1e4)e.push(...t.slice(f,f+1e4))}function U(e,t){return e===t?!0:e instanceof Uint8Array&&t instanceof Uint8Array?U(Array.from(e),Array.from(t)):!e||!t||typeof e!=typeof t?!1:Array.isArray(e)&&Array.isArray(t)?e.length===t.length&&e.every((n,f)=>U(n,t[f])):typeof e=="object"&&Object.keys(e).length===Object.keys(t).length&&Object.keys(e).every(n=>U(e[n],t[n]))}async function lt(e,t,n){return await(n??globalThis.fetch)(e,{...t,method:"HEAD"}).then(r=>{if(!r.ok)throw new Error(`fetch head failed ${r.status}`);const i=r.headers.get("Content-Length");if(!i)throw new Error("missing content length");return parseInt(i)})}async function yt({url:e,byteLength:t,requestInit:n,fetch:f}){if(!e)throw new Error("missing url");const r=f??globalThis.fetch;t||(t=await lt(e,n,r));let i;const s=n||{};return{byteLength:t,async slice(o,u){if(i)return i.then(h=>h.slice(o,u));const a=new Headers(s.headers),c=u===void 0?"":u-1;a.set("Range",`bytes=${o}-${c}`);const l=await r(e,{...s,headers:a});if(!l.ok||!l.body)throw new Error(`fetch failed ${l.status}`);if(l.status===200)return i=l.arrayBuffer(),i.then(h=>h.slice(o,u));if(l.status===206)return l.arrayBuffer();throw new Error(`fetch received unexpected status code ${l.status}`)}}}async function pt(e){const t="fs",n=await De(()=>import(t),[]);return{byteLength:(await n.promises.stat(e)).size,async slice(r,i){const s=n.createReadStream(e,{start:r,end:i});return await ct(s)}}}function ct(e){return new Promise((t,n)=>{const f=[];e.on("data",r=>f.push(r)),e.on("end",()=>{const r=Buffer.concat(f);t(r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength))}),e.on("error",n)})}function It({byteLength:e,slice:t},{minSize:n=ge}={}){if(e<n){const r=t(0,e);return{byteLength:e,async slice(i,s){return(await r).slice(i,s)}}}const f=new Map;return{byteLength:e,slice(r,i){const s=at(r,i,e),o=f.get(s);if(o)return o;const u=t(r,i);return f.set(s,u),u}}}function at(e,t,n){if(e<0){if(t!==void 0)throw new Error(`invalid suffix range [${e}, ${t}]`);return n===void 0?`${e},`:`${n+e},${n}`}else if(t!==void 0){if(e>t)throw new Error(`invalid empty range [${e}, ${t}]`);return`${e},${t}`}else return n===void 0?`${e},`:`${e},${n}`}const _t=1<<25;function dt({metadata:e,rowStart:t=0,rowEnd:n=1/0,columns:f}){var o,u;if(!e)throw new Error("parquetPlan requires metadata");const r=[],i=[];let s=0;for(const a of e.row_groups){const c=s+Number(a.num_rows);if(c>=t&&s<n){const l=[];for(const{file_path:d,meta_data:A}of a.columns){if(d)throw new Error("parquet file_path not supported");if(!A)throw new Error("parquet column metadata is undefined");(!f||f.includes(A.path_in_schema[0]))&&l.push(be(A))}r.push({plan:l});const h=((o=l[l.length-1])==null?void 0:o.endByte)-((u=l[0])==null?void 0:u.startByte);if(!f&&h<_t)i.push({startByte:l[0].startByte,endByte:l[l.length-1].endByte});else if(l.length)Z(i,l);else if(f!=null&&f.length)throw new Error(`parquet columns not found: ${f.join(", ")}`)}s=c}return{ranges:i,groups:r}}function be({dictionary_page_offset:e,data_page_offset:t,total_compressed_size:n}){const f=e||t;return{startByte:Number(f),endByte:Number(f+n)}}function wt(e,{ranges:t}){const n=t.map(({startByte:f,endByte:r})=>e.slice(f,r));return{byteLength:e.byteLength,slice(f,r=e.byteLength){const i=t.findIndex(({startByte:s,endByte:o})=>s<=f&&r<=o);if(i<0)throw new Error(`no prefetch for range [${f}, ${r}]`);if(t[i].startByte!==f||t[i].endByte!==r){const s=f-t[i].startByte,o=r-t[i].startByte;return n[i]instanceof Promise?n[i].then(u=>u.slice(s,o)):n[i].slice(s,o)}else return n[i]}}}async function ht(e){if(!e.file||!(e.file.byteLength>=0))throw new Error("parquetRead expected file AsyncBuffer");e.metadata??(e.metadata=await Q(e.file));const{metadata:t,onComplete:n,rowStart:f=0,rowEnd:r}=e;if(f<0)throw new Error("parquetRead rowStart must be positive");const i=dt(e);e.file=wt(e.file,i);const s=[];let o=0;for(const u of t.row_groups){const a=Number(u.num_rows);if(o+a>=f&&(r===void 0||o<r)){const c=await At(e,u,o);if(n){const l=Math.max(f-o,0),h=r===void 0?void 0:r-o;Z(s,c.slice(l,h))}}o+=a}n&&n(s)}async function At(e,t,n){var m;const{file:f,metadata:r,columns:i,rowStart:s=0,rowEnd:o}=e;if(!r)throw new Error("parquet metadata not found");const u=Number(t.num_rows),a=Math.max(s-n,0),c=Math.min((o??1/0)-n,u),l={groupStart:n,selectStart:a,selectEnd:c,numRows:u},h=[],{children:d}=V(r.schema,[])[0],A=new Map(d.map(_=>[_.element.name,ve(_)])),g=new Map;for(const{file_path:_,meta_data:E}of t.columns){if(_)throw new Error("parquet file_path not supported");if(!E)throw new Error("parquet column metadata is undefined");const w=E.path_in_schema[0];if(i&&!i.includes(w))continue;const{startByte:v,endByte:y}=be(E),I=y-v;if(I>1<<30){console.warn(`parquet skipping huge column "${E.path_in_schema}" ${I} bytes`);continue}const b=Promise.resolve(f.slice(v,y));h.push(b.then(Le=>{const x=V(r.schema,E.path_in_schema),Ne={view:new DataView(Le),offset:0},H=E.path_in_schema.join("."),Re={columnName:H,type:E.type,element:x[x.length-1].element,schemaPath:x,codec:E.codec,compressors:e.compressors,utf8:e.utf8};let O=ot(Ne,l,Re,e.onPage);if(!e.onComplete&&!e.onChunk)return;g.set(H,O),O=void 0;const P=A.get(w);if(P!=null&&P.every(N=>g.has(N))){const N=new Map(P.map($=>[$,se(g.get($))]));B(N,x[1]);const K=N.get(w);if(!K)throw new Error(`parquet column data not assembled: ${w}`);O=[K],P.forEach($=>g.delete($)),g.set(w,O)}if(O&&e.onChunk)for(const N of O)e.onChunk({columnName:w,columnData:N,rowStart:n,rowEnd:n+N.length})}))}if(await Promise.all(h),e.onComplete){const _=d.map(y=>y.element.name).filter(y=>!i||i.includes(y)),E=i||_,w=E.map(y=>_.includes(y)?se(g.get(y)):void 0),v=new Array(c);for(let y=a;y<c;y++)if(e.rowFormat==="object"){const I={};for(let b=0;b<E.length;b++)I[E[b]]=(m=w[b])==null?void 0:m[y];v[y]=I}else v[y]=w.map(I=>I==null?void 0:I[y]);return v}return[]}function se(e){if(!e)return[];if(e.length===1)return e[0];const t=[];for(const n of e)Z(t,n);return t}function ve(e,t=[]){if(e.children.length)for(const n of e.children)ve(n,t);else t.push(e.path.join("."));return t}async function bt(e){if(!e.file||!(e.file.byteLength>=0))throw new Error("parquetQuery expected file AsyncBuffer");e.metadata??(e.metadata=await Q(e.file));const{metadata:t,rowStart:n=0,orderBy:f,filter:r}=e;if(n<0)throw new Error("parquetQuery rowStart must be positive");const i=e.rowEnd??Number(t.num_rows);if(r&&!f&&i<t.num_rows){const s=new Array;let o=0;for(const u of t.row_groups){const a=o+Number(u.num_rows),c=await S({...e,rowStart:o,rowEnd:a});for(const l of c)T(l,r)&&s.push(l);if(s.length>=i)break;o=a}return s.slice(n,i)}else if(r){const s=(await S({...e,rowStart:void 0,rowEnd:void 0})).filter(o=>T(o,r));return f&&s.sort((o,u)=>oe(o[f],u[f])),s.slice(n,i)}else if(typeof f=="string"){const s=await S({...e,rowStart:void 0,rowEnd:void 0,columns:[f]}),o=Array.from(s,(c,l)=>l).sort((c,l)=>oe(s[c][f],s[l][f])).slice(n,i),u=await Et({...e,rows:o});return o.map(c=>u[c])}else return await S(e)}async function Et(e){const{file:t,rows:n}=e;e.metadata||(e.metadata=await Q(t));const{row_groups:f}=e.metadata,r=Array(f.length).fill(!1);let i=0;const s=f.map(c=>i+=Number(c.num_rows));for(const c of n){const l=s.findIndex(h=>c<h);r[l]=!0}const o=[];let u;i=0;for(let c=0;c<r.length;c++){const l=i+Number(f[c].num_rows);r[c]?u===void 0&&(u=i):u!==void 0&&(o.push([u,l]),u=void 0),i=l}u!==void 0&&o.push([u,i]);const a=new Array(Number(e.metadata.num_rows));for(const[c,l]of o){const h=await S({...e,rowStart:c,rowEnd:l});for(let d=c;d<l;d++)a[d]=h[d-c],a[d].__index__=d}return a}function oe(e,t){return e<t?-1:e>t?1:0}function T(e,t={}){return t.$not?!T(e,t.$not):t.$and?t.$and.every(n=>T(e,n)):t.$or?t.$or.some(n=>T(e,n)):Object.entries(t).every(([n,f])=>{const r=e[n];return f!==null&&(Array.isArray(f)||typeof f!="object")?U(r,f):Object.entries(f||{}).every(([i,s])=>{switch(i){case"$gt":return r>s;case"$gte":return r>=s;case"$lt":return r<s;case"$lte":return r<=s;case"$ne":return!U(r,s);case"$in":return Array.isArray(s)&&s.includes(r);case"$nin":return Array.isArray(s)&&!s.includes(r);case"$not":return!T({[n]:r},{[n]:s});default:return!0}})})}function S(e){return new Promise((t,n)=>{ht({rowFormat:"object",...e,onComplete:t}).catch(n)})}export{pt as asyncBufferFromFile,yt as asyncBufferFromUrl,lt as byteLengthFromUrl,It as cachedAsyncBuffer,ee as parquetMetadata,Q as parquetMetadataAsync,bt as parquetQuery,ht as parquetRead,S as parquetReadObjects,mt as parquetSchema,et as snappyUncompress,ie as toJson};
